<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<script>
		// Catch incoming messages
        chrome.extension.onConnect.addListener(function(port) {
                port.onMessage.addListener(function(event) {
                        // Here comes the settings request, send back the entire localStoreage
                        if(event.name == 'getSettings') {
                                port.postMessage({ name : "setSettings", message : localStorage });
                        }
						
						if (event.type == "getStorageData") {
							port.postMessage({ type : "setStorageData", data : localStorage });
							chrome.pageAction.show(port.sender.tab.id);
				
						} else if(event.type == "setBlockedUser") {
							addToBlockList(event.data);
						}
                });
        });
		
		
/* 		chrome.extension.onConnect.addListener(function(port) {
			port.onMessage.addListener(function(msg) {
			
				if (msg.type == "getStorageData") {
					port.postMessage({ type : "setStorageData", data : localStorage });
					chrome.pageAction.show(port.sender.tab.id);
				
				} else if(msg.type == "setBlockedUser") {
					addToBlockList(msg.data);
				}

			});		
		}); */
		
		function addToBlockList(name){
		
			// If theres in no entry in localStorage
			if(typeof localStorage['block_list'] == "undefined") {
				localStorage['block_list'] = '';
			}
			
			// If the blocklist is empty
			if(localStorage['block_list'] == '') { 
				localStorage['block_list'] = name;
			
			// If the blocklist is not empty
			} else {
				var blocklist = new Array();
					blockList = localStorage['block_list'].split(',');
					if(blockList.indexOf(name) == -1) { blockList.push(name);  localStorage['block_list'] = blockList; }
			}
		}
		
		
		function install_notice() {
			if (localStorage.getItem('install_time'))
				return;
                    var now = new Date().getTime();
                    localStorage.setItem('install_time', now);
                chrome.tabs.create({url: "html/settings.html"});
                }
		install_notice();
		</script>
	</head>
</html>
